'use client'

import {
  Box,
  Heading,
  Text,
  VStack,
  HStack,
  Grid,
  Card,
  CardBody,
  CardHeader,
  Badge,
  Divider,
  Accordion,
  AccordionItem,
  AccordionButton,
  AccordionPanel,
  AccordionIcon,
  Table,
  Thead,
  Tbody,
  Tr,
  Th,
  Td,
  TableContainer,
  Tabs,
  TabList,
  TabPanels,
  Tab,
  TabPanel,
  Code,
  Alert,
  AlertIcon,
  AlertTitle,
  AlertDescription,
  useColorModeValue,
  Flex,
  Spacer,
  Icon,
  SimpleGrid
} from '@chakra-ui/react'
import { useEffect, useState } from 'react'
import { Database, Table as TableIcon, Key, Link, Settings, Shield, Zap, GitBranch } from 'lucide-react'
import Layout from '@/components/layout/Layout'
import ProtectedRoute from '@/components/auth/ProtectedRoute'
import SimpleDiagram from '@/components/schema/SimpleDiagram'
import ReactFlowDiagram from '@/components/schema/VisNetworkDiagram'

interface Column {
  name: string
  type: string
  primaryKey?: boolean
  nullable?: boolean
  default?: string
  description: string
}

interface Relationship {
  type: string
  table: string
  column: string
  description: string
}

interface TableSchema {
  name: string
  description: string
  columns: Column[]
  relationships: Relationship[]
}

interface EnumSchema {
  name: string
  values: string[]
  description: string
}

interface IndexSchema {
  table: string
  columns: string[]
  description: string
}

interface FunctionSchema {
  name: string
  description: string
  trigger?: string
  parameters?: string
  returns?: string
}

interface RLSPolicy {
  table: string
  description: string
}

interface SchemaData {
  tables: TableSchema[]
  enums: EnumSchema[]
  indexes: IndexSchema[]
  functions: FunctionSchema[]
  rls_policies: RLSPolicy[]
}

export default function SchemaPage() {
  const [schemaData, setSchemaData] = useState<SchemaData | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const bgColor = useColorModeValue('gray.50', 'gray.900')
  const cardBg = useColorModeValue('white', 'gray.800')
  const borderColor = useColorModeValue('gray.200', 'gray.600')

  useEffect(() => {
    fetchSchemaData()
  }, [])

  const fetchSchemaData = async () => {
    try {
      const response = await fetch('/api/schema')
      if (!response.ok) {
        throw new Error('Failed to fetch schema data')
      }
      const data = await response.json()
      setSchemaData(data)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Unknown error')
    } finally {
      setLoading(false)
    }
  }

  const getTypeColor = (type: string) => {
    if (type.includes('UUID')) return 'purple'
    if (type.includes('TEXT') || type.includes('VARCHAR')) return 'green'
    if (type.includes('INTEGER') || type.includes('DECIMAL')) return 'blue'
    if (type.includes('BOOLEAN')) return 'orange'
    if (type.includes('TIMESTAMP')) return 'cyan'
    if (type.includes('JSONB') || type.includes('JSON')) return 'pink'
    if (type.includes('ARRAY') || type.includes('[]')) return 'teal'
    if (type.includes('_enum') || type.includes('_type')) return 'red'
    return 'gray'
  }

  const renderTable = (table: TableSchema) => (
    <Card key={table.name} bg={cardBg} borderColor={borderColor}>
      <CardHeader pb={2}>
        <HStack>
          <Icon as={TableIcon} color="blue.500" />
          <VStack align="start" spacing={0} flex={1}>
            <Heading size="md" color="blue.600">
              {table.name}
            </Heading>
            <Text fontSize="sm" color="gray.600">
              {table.description}
            </Text>
          </VStack>
        </HStack>
      </CardHeader>
      
      <CardBody pt={0}>
        <VStack spacing={4} align="stretch">
          {/* Columns */}
          <Box>
            <Text fontSize="sm" fontWeight="semibold" mb={2} color="gray.700">
              Ïª¨Îüº ({table.columns.length}Í∞ú)
            </Text>
            <TableContainer>
              <Table size="sm" variant="simple">
                <Thead>
                  <Tr>
                    <Th>Ïù¥Î¶Ñ</Th>
                    <Th>ÌÉÄÏûÖ</Th>
                    <Th>ÏÜçÏÑ±</Th>
                    <Th>ÏÑ§Î™Ö</Th>
                  </Tr>
                </Thead>
                <Tbody>
                  {table.columns.map((column) => (
                    <Tr key={column.name}>
                      <Td>
                        <HStack spacing={2}>
                          <Text fontFamily="mono" fontSize="sm">
                            {column.name}
                          </Text>
                          {column.primaryKey && (
                            <Icon as={Key} size={14} color="yellow.500" />
                          )}
                        </HStack>
                      </Td>
                      <Td>
                        <Badge colorScheme={getTypeColor(column.type)} fontSize="xs">
                          {column.type}
                        </Badge>
                      </Td>
                      <Td>
                        <HStack spacing={1}>
                          {column.nullable === false && (
                            <Badge size="sm" colorScheme="red" variant="outline">
                              NOT NULL
                            </Badge>
                          )}
                          {column.default && (
                            <Badge size="sm" colorScheme="gray" variant="outline">
                              DEFAULT
                            </Badge>
                          )}
                        </HStack>
                      </Td>
                      <Td fontSize="sm" color="gray.600">
                        {column.description}
                        {column.default && (
                          <Text fontSize="xs" color="gray.500" mt={1}>
                            Í∏∞Î≥∏Í∞í: {column.default}
                          </Text>
                        )}
                      </Td>
                    </Tr>
                  ))}
                </Tbody>
              </Table>
            </TableContainer>
          </Box>

          {/* Relationships */}
          {table.relationships.length > 0 && (
            <Box>
              <Text fontSize="sm" fontWeight="semibold" mb={2} color="gray.700">
                Í¥ÄÍ≥Ñ ({table.relationships.length}Í∞ú)
              </Text>
              <VStack spacing={2} align="stretch">
                {table.relationships.map((rel, idx) => (
                  <Box key={idx} p={2} bg="gray.50" borderRadius="md" border="1px solid" borderColor="gray.200">
                    <HStack>
                      <Icon as={Link} size={16} color="green.500" />
                      <Badge colorScheme="green" size="sm">
                        {rel.type}
                      </Badge>
                      <Text fontSize="sm">
                        ‚Üí <Code fontSize="sm">{rel.table}.{rel.column}</Code>
                      </Text>
                    </HStack>
                    <Text fontSize="xs" color="gray.600" mt={1}>
                      {rel.description}
                    </Text>
                  </Box>
                ))}
              </VStack>
            </Box>
          )}
        </VStack>
      </CardBody>
    </Card>
  )

  if (loading) {
    return (
      <ProtectedRoute>
        <Layout>
          <VStack spacing={8} align="center" py={20}>
            <Database size={48} />
            <Text>Ïä§ÌÇ§Îßà Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</Text>
          </VStack>
        </Layout>
      </ProtectedRoute>
    )
  }

  if (error || !schemaData) {
    return (
      <ProtectedRoute>
        <Layout>
          <Alert status="error">
            <AlertIcon />
            <AlertTitle>Ïä§ÌÇ§Îßà Î°úÎìú Ïã§Ìå®</AlertTitle>
            <AlertDescription>{error || 'Ïä§ÌÇ§Îßà Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.'}</AlertDescription>
          </Alert>
        </Layout>
      </ProtectedRoute>
    )
  }

  return (
    <ProtectedRoute>
      <Layout>
        <VStack spacing={8} align="stretch">
          {/* Header */}
          <Box>
            <HStack mb={4}>
              <Icon as={Database} size={32} color="blue.500" />
              <VStack align="start" spacing={0}>
                <Heading size="xl" color="gray.800">
                  üìä Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§Îßà
                </Heading>
                <Text color="gray.600" fontSize="lg">
                  AI SNS ÏΩòÌÖêÏ∏† ÏÉùÏÑ± ÌîåÎû´ÌèºÏùò Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Íµ¨Ï°∞ ÏãúÍ∞ÅÌôî
                </Text>
              </VStack>
            </HStack>
            
            <SimpleGrid columns={{ base: 2, md: 4 }} spacing={4} mb={6}>
              <Card bg={cardBg} textAlign="center" p={4}>
                <VStack>
                  <Icon as={TableIcon} size={24} color="blue.500" />
                  <Text fontSize="2xl" fontWeight="bold" color="blue.600">
                    {schemaData.tables.length}
                  </Text>
                  <Text fontSize="sm" color="gray.600">ÌÖåÏù¥Î∏î</Text>
                </VStack>
              </Card>
              <Card bg={cardBg} textAlign="center" p={4}>
                <VStack>
                  <Icon as={Settings} size={24} color="purple.500" />
                  <Text fontSize="2xl" fontWeight="bold" color="purple.600">
                    {schemaData.enums.length}
                  </Text>
                  <Text fontSize="sm" color="gray.600">Ïó¥Í±∞Ìòï</Text>
                </VStack>
              </Card>
              <Card bg={cardBg} textAlign="center" p={4}>
                <VStack>
                  <Icon as={Zap} size={24} color="green.500" />
                  <Text fontSize="2xl" fontWeight="bold" color="green.600">
                    {schemaData.functions.length}
                  </Text>
                  <Text fontSize="sm" color="gray.600">Ìï®Ïàò</Text>
                </VStack>
              </Card>
              <Card bg={cardBg} textAlign="center" p={4}>
                <VStack>
                  <Icon as={Shield} size={24} color="red.500" />
                  <Text fontSize="2xl" fontWeight="bold" color="red.600">
                    {schemaData.rls_policies.length}
                  </Text>
                  <Text fontSize="sm" color="gray.600">RLS Ï†ïÏ±Ö</Text>
                </VStack>
              </Card>
            </SimpleGrid>
          </Box>

          <Tabs variant="enclosed" colorScheme="blue">
            <TabList>
              <Tab>üìã ÌÖåÏù¥Î∏î</Tab>
              <Tab>üè∑Ô∏è Ïó¥Í±∞Ìòï</Tab>
              <Tab>‚ö° Ìï®Ïàò</Tab>
              <Tab>üîç Ïù∏Îç±Ïä§</Tab>
              <Tab>üõ°Ô∏è Î≥¥Ïïà</Tab>
              <Tab>üìä Îã§Ïù¥Ïñ¥Í∑∏Îû®</Tab>
            </TabList>

            <TabPanels>
              {/* Tables Tab */}
              <TabPanel px={0}>
                <VStack spacing={6} align="stretch">
                  {schemaData.tables.map(renderTable)}
                </VStack>
              </TabPanel>

              {/* Enums Tab */}
              <TabPanel px={0}>
                <SimpleGrid columns={{ base: 1, lg: 2 }} spacing={6}>
                  {schemaData.enums.map((enumSchema) => (
                    <Card key={enumSchema.name} bg={cardBg}>
                      <CardHeader>
                        <HStack>
                          <Icon as={Settings} color="purple.500" />
                          <VStack align="start" spacing={0}>
                            <Heading size="md" color="purple.600">
                              {enumSchema.name}
                            </Heading>
                            <Text fontSize="sm" color="gray.600">
                              {enumSchema.description}
                            </Text>
                          </VStack>
                        </HStack>
                      </CardHeader>
                      <CardBody pt={0}>
                        <Text fontSize="sm" fontWeight="semibold" mb={2}>
                          Í∞ÄÎä•Ìïú Í∞í:
                        </Text>
                        <Flex wrap="wrap" gap={2}>
                          {enumSchema.values.map((value) => (
                            <Badge key={value} colorScheme="purple" variant="outline">
                              {value}
                            </Badge>
                          ))}
                        </Flex>
                      </CardBody>
                    </Card>
                  ))}
                </SimpleGrid>
              </TabPanel>

              {/* Functions Tab */}
              <TabPanel px={0}>
                <VStack spacing={4} align="stretch">
                  {schemaData.functions.map((func) => (
                    <Card key={func.name} bg={cardBg}>
                      <CardBody>
                        <HStack align="start" spacing={4}>
                          <Icon as={Zap} color="green.500" mt={1} />
                          <VStack align="start" spacing={2} flex={1}>
                            <Code colorScheme="green" fontSize="md">
                              {func.name}
                            </Code>
                            <Text fontSize="sm" color="gray.600">
                              {func.description}
                            </Text>
                            {func.trigger && (
                              <Badge colorScheme="orange" size="sm">
                                Ìä∏Î¶¨Í±∞: {func.trigger}
                              </Badge>
                            )}
                            {func.parameters && (
                              <Text fontSize="xs" color="gray.500">
                                Îß§Í∞úÎ≥ÄÏàò: {func.parameters}
                              </Text>
                            )}
                            {func.returns && (
                              <Text fontSize="xs" color="gray.500">
                                Î∞òÌôòÍ∞í: {func.returns}
                              </Text>
                            )}
                          </VStack>
                        </HStack>
                      </CardBody>
                    </Card>
                  ))}
                </VStack>
              </TabPanel>

              {/* Indexes Tab */}
              <TabPanel px={0}>
                <TableContainer>
                  <Table variant="simple">
                    <Thead>
                      <Tr>
                        <Th>ÌÖåÏù¥Î∏î</Th>
                        <Th>Ïª¨Îüº</Th>
                        <Th>ÏÑ§Î™Ö</Th>
                      </Tr>
                    </Thead>
                    <Tbody>
                      {schemaData.indexes.map((index, idx) => (
                        <Tr key={idx}>
                          <Td>
                            <Badge colorScheme="blue">
                              {index.table}
                            </Badge>
                          </Td>
                          <Td>
                            <Code fontSize="sm">
                              {index.columns.join(', ')}
                            </Code>
                          </Td>
                          <Td fontSize="sm" color="gray.600">
                            {index.description}
                          </Td>
                        </Tr>
                      ))}
                    </Tbody>
                  </Table>
                </TableContainer>
              </TabPanel>

              {/* Security Tab */}
              <TabPanel px={0}>
                <VStack spacing={4} align="stretch">
                  <Alert status="info">
                    <AlertIcon />
                    <AlertTitle>Row Level Security (RLS)</AlertTitle>
                    <AlertDescription>
                      Î™®Îì† ÌÖåÏù¥Î∏îÏóê RLSÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏÇ¨Ïö©ÏûêÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï†ëÍ∑ºÏùÑ Ï†úÌïúÌï©ÎãàÎã§.
                    </AlertDescription>
                  </Alert>
                  
                  {schemaData.rls_policies.map((policy, idx) => (
                    <Card key={idx} bg={cardBg}>
                      <CardBody>
                        <HStack align="start">
                          <Icon as={Shield} color="red.500" mt={1} />
                          <VStack align="start" spacing={1}>
                            <Badge colorScheme="red">
                              {policy.table}
                            </Badge>
                            <Text fontSize="sm" color="gray.600">
                              {policy.description}
                            </Text>
                          </VStack>
                        </HStack>
                      </CardBody>
                    </Card>
                  ))}
                </VStack>
              </TabPanel>

              {/* Diagrams Tab */}
              <TabPanel px={0}>
                <VStack spacing={6} align="stretch">
                  <Alert status="info">
                    <AlertIcon />
                    <AlertTitle>Îã§Ïù¥Ïñ¥Í∑∏Îû® ÏïàÎÇ¥</AlertTitle>
                    <AlertDescription>
                      Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§ÎßàÎ•º Îã§ÏñëÌïú Î∞©ÏãùÏúºÎ°ú ÏãúÍ∞ÅÌôîÌï©ÎãàÎã§. Í∞ÑÎã® Î≤ÑÏ†ÑÍ≥º Ïù∏ÌÑ∞ÎûôÌã∞Î∏å ÎÑ§Ìä∏ÏõåÌÅ¨ Îã§Ïù¥Ïñ¥Í∑∏Îû®ÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§.
                    </AlertDescription>
                  </Alert>

                  <Tabs variant="soft-rounded" colorScheme="purple" defaultIndex={1}>
                    <TabList>
                      <Tab>üé® Í∞ÑÎã® Î≤ÑÏ†Ñ</Tab>
                      <Tab>üåê ÎÑ§Ìä∏ÏõåÌÅ¨</Tab>
                    </TabList>
                    
                    <TabPanels>
                      {/* Simple Diagrams Tab */}
                      <TabPanel px={0}>
                        <VStack spacing={6} align="stretch">
                          <Alert status="info">
                            <AlertIcon />
                            <AlertTitle>Í∞ÑÎã®Ìïú Îã§Ïù¥Ïñ¥Í∑∏Îû®</AlertTitle>
                            <AlertDescription>
                              HTML/CSSÎ°ú Íµ¨ÌòÑÎêú Í∞ÄÎ≥çÍ≥† Îπ†Î•∏ Îã§Ïù¥Ïñ¥Í∑∏Îû®ÏûÖÎãàÎã§. Î≥ÑÎèÑ ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏóÜÏù¥ Ï¶âÏãú Î†åÎçîÎßÅÎê©ÎãàÎã§.
                            </AlertDescription>
                          </Alert>

                          <Tabs variant="enclosed" size="sm">
                            <TabList>
                              <Tab>ERD</Tab>
                              <Tab>Í¥ÄÍ≥ÑÎèÑ</Tab>
                              <Tab>Îç∞Ïù¥ÌÑ∞ ÌîåÎ°úÏö∞</Tab>
                            </TabList>
                            
                            <TabPanels>
                              <TabPanel>
                                <Card bg={cardBg}>
                                  <CardBody>
                                    <SimpleDiagram type="erd" />
                                  </CardBody>
                                </Card>
                              </TabPanel>
                              
                              <TabPanel>
                                <Card bg={cardBg}>
                                  <CardBody>
                                    <SimpleDiagram type="flowchart" />
                                  </CardBody>
                                </Card>
                              </TabPanel>
                              
                              <TabPanel>
                                <Card bg={cardBg}>
                                  <CardBody>
                                    <SimpleDiagram type="dataflow" />
                                  </CardBody>
                                </Card>
                              </TabPanel>
                            </TabPanels>
                          </Tabs>
                        </VStack>
                      </TabPanel>

                      {/* React Flow Network Tab */}
                      <TabPanel px={0}>
                        <VStack spacing={6} align="stretch">
                          <Alert status="success">
                            <AlertIcon />
                            <AlertTitle>React Flow Ïù∏ÌÑ∞ÎûôÌã∞Î∏å Îã§Ïù¥Ïñ¥Í∑∏Îû®</AlertTitle>
                            <AlertDescription>
                              React FlowÎ°ú Íµ¨ÌòÑÎêú Ïù∏ÌÑ∞ÎûôÌã∞Î∏å ÎÑ§Ìä∏ÏõåÌÅ¨ÏûÖÎãàÎã§. ÎÖ∏ÎìúÎ•º ÎìúÎûòÍ∑∏ÌïòÍ≥† Ï§å/Ìå¨Ïù¥ Í∞ÄÎä•ÌïòÎ©∞ ÎØ∏ÎãàÎßµÎèÑ Ï†úÍ≥µÎê©ÎãàÎã§.
                            </AlertDescription>
                          </Alert>

                          <Tabs variant="enclosed" size="sm">
                            <TabList>
                              <Tab>üîÑ ÎèôÏ†Å Î†àÏù¥ÏïÑÏõÉ</Tab>
                              <Tab>üìä Í≥ÑÏ∏µÌòï Î†àÏù¥ÏïÑÏõÉ</Tab>
                            </TabList>
                            
                            <TabPanels>
                              <TabPanel>
                                <Card bg={cardBg}>
                                  <CardHeader>
                                    <VStack align="start" spacing={0}>
                                      <Heading size="md" color="blue.600">
                                        ÎèôÏ†Å ÎÑ§Ìä∏ÏõåÌÅ¨ Îã§Ïù¥Ïñ¥Í∑∏Îû®
                                      </Heading>
                                      <Text fontSize="sm" color="gray.600">
                                        Î¨ºÎ¶¨ ÏãúÎÆ¨Î†àÏù¥ÏÖòÏúºÎ°ú ÏûêÎèô Î∞∞ÏπòÎêòÎäî Ïù∏ÌÑ∞ÎûôÌã∞Î∏å Îã§Ïù¥Ïñ¥Í∑∏Îû®
                                      </Text>
                                    </VStack>
                                  </CardHeader>
                                  <CardBody pt={0}>
                                    <ReactFlowDiagram 
                                      schemaData={schemaData} 
                                      type="network"
                                    />
                                  </CardBody>
                                </Card>
                              </TabPanel>
                              
                              <TabPanel>
                                <Card bg={cardBg}>
                                  <CardHeader>
                                    <VStack align="start" spacing={0}>
                                      <Heading size="md" color="green.600">
                                        Í≥ÑÏ∏µÌòï ÎÑ§Ìä∏ÏõåÌÅ¨ Îã§Ïù¥Ïñ¥Í∑∏Îû®  
                                      </Heading>
                                      <Text fontSize="sm" color="gray.600">
                                        ÏúÑÏïÑÎûò Í≥ÑÏ∏µ Íµ¨Ï°∞Î°ú Ï†ïÎ†¨Îêú Îã§Ïù¥Ïñ¥Í∑∏Îû®
                                      </Text>
                                    </VStack>
                                  </CardHeader>
                                  <CardBody pt={0}>
                                    <ReactFlowDiagram 
                                      schemaData={schemaData} 
                                      type="hierarchy"
                                    />
                                  </CardBody>
                                </Card>
                              </TabPanel>
                            </TabPanels>
                          </Tabs>
                        </VStack>
                      </TabPanel>
                    </TabPanels>
                  </Tabs>
                </VStack>
              </TabPanel>
            </TabPanels>
          </Tabs>
        </VStack>
      </Layout>
    </ProtectedRoute>
  )
}